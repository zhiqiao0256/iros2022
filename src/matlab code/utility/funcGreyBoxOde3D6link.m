function [dx, y] = funcGreyBoxOde3D6link(t, x, u, a11,a22,k11,k22,b11,b22, varargin)
% Output equations.
y = [x(1);    % Angular position.
    x(2)
    x(3)
    x(4)];    % Angular velocity.
% State equations.
m0=0.35;     % segment weight kg
g=9.8;       % gravity
L=0.185;
l_tri=0.015;% segment length
Rp1=deg2rad(240);
pm1=u(1);    % Chamber 1 measured pressure
pm2=u(2);    % Chamber 2 measured pressure
pm3=u(3);    % Chamber 3 measured pressure
% theta=u(4);     % Off-set parameter for CC assumption
% phi=u(5);    % Azumuth angle
phi=x(1);
dphi=x(2);
theta=x(3);
dtheta=x(4);
%    Izz=m0*r0^2;
%    Iyz=0.
% Update Parameters
if abs(theta)<=pi/180*0.05 
    m11=0;
    m12=0;
    m21=0;
    m22=m0*(L/2)^2;
else
    m11 = (l_tri^2*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))^2*sin(theta/2)^2)/(12*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))^4) - (5*m0*sin(theta/2)^2*(cos(theta) - 1)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2)/2;
    
    m12 = (3^(1/2)*l_tri*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2)*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2))/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))^2) - (m0*cos(theta/2)^2*sin(theta/2)^4*cos(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^4*(cos(theta/2)^2 - 1)*(cos(phi)^2 + sin(phi)*cos(phi) - 1))/2;
    
    m21 = (3^(1/2)*l_tri*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2)*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2))/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))^2) - (m0*cos(theta/2)^2*sin(theta/2)^4*cos(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^4*(cos(theta/2)^2 - 1)*(cos(phi)^2 + sin(phi)*cos(phi) - 1))/2;
    
    m22 = m0*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)^2 + m0*sin(theta/2)^4*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + m0*cos(theta/2)^2*sin(theta/2)^2*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + m0*cos(theta/2)^2*sin(theta/2)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + (m0*sin(theta/2)^2*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(sin(theta/2)^2*cos(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/4 + (m0*sin(theta/2)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(sin(theta/2)^2*sin(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)^3*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/4;
    
end
M=[m11 m12;m21 m22];
c11 =  - (5*m0*sin(theta/2)*(cos(theta) - 1)*(dtheta*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2) + (3^(1/2)*dphi*l_tri*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2))/(6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2))*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))))/2 - (5*dtheta*m0*sin(theta)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(cos(theta)/2 - 1/2))/4 - (l_tri^2*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2)*(3*sin(theta/2) - (3*cos(theta/2 + pi/6 - 2*mod(Rp1 + phi, (2*pi)/3)))/4 + sin(theta/2 + pi/3 + 2*mod(Rp1 + phi, (2*pi)/3))/4))/(24*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^5);

c12 = (3^(1/2)*l_tri*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2)*(sin(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (2*L*cos(theta/2))/theta^2 + (2*L*sin(theta/2))/theta^3))/(6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2) - (cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*((3*dphi*m0*sin(theta/2)*(cos(theta) - 1)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))))/2 - dtheta*m0*sin(theta/2)^3*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2)) - (3^(1/2)*l_tri*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2)*((dtheta*m0*sin(theta/2)*(36*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*(cos(theta)/2 - 1/2) - 72*L^3*sin(theta/2)^6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*cos(phi)^3*sin(phi)^3 - 54*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*cos(phi)^2*(cos(theta)/2 + 1/2) + 18*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*cos(phi)^4*(cos(theta)/2 - 1/2) - 54*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*sin(phi)^2*(cos(theta)/2 + 1/2) + 18*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*sin(phi)^4*(cos(theta)/2 - 1/2) - 6*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*(cos(theta)/2 - 1/2) + 3^(1/2)*l_tri^3*theta^3*sin(theta/2)^6*cos(phi)^3*sin(phi)^3 + 9*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*cos(phi)^2*(cos(theta)/2 + 1/2) - 3*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*cos(phi)^4*(cos(theta)/2 - 1/2) + 9*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*sin(phi)^2*(cos(theta)/2 + 1/2) - 3*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*sin(phi)^4*(cos(theta)/2 - 1/2) - 18*L*l_tri^2*theta^2*sin(theta/2)^6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))*cos(phi)^3*sin(phi)^3 + 36*3^(1/2)*L^2*l_tri*theta*sin(theta/2)^6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*cos(phi)^3*sin(phi)^3))/(36*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3) - 2*dphi*m0*sin(theta/2)^3*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2)))/(12*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2) - dphi*m0*sin(theta/2)*(cos(theta) - 1)*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (dphi*((5*m0*sin(theta)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(cos(theta)/2 - 1/2))/2 + m0*sin(theta/2)^4*sin(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^4*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2) - 2^(1/2)*m0*cos(2*phi + pi/4)*sin(theta/2)^4*cos(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^4*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2)))/2 - m0*sin(theta/2)^3*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(dtheta*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2) + (3^(1/2)*dphi*l_tri*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2))/(6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2))*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2) - (dtheta*m0*cos(2*phi)*sin(theta/2)^4*cos(phi)*sin(phi)*(96*L^2*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^4 + 8*l_tri^2*theta^4*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2 - l_tri^4*theta^4*sin(theta/2)^4*cos(phi)*sin(phi) - 32*3^(1/2)*L*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3 - 144*L^4*sin(theta/2)^4*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^4*cos(phi)*sin(phi) - 72*L^2*l_tri^2*theta^2*sin(theta/2)^4*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*cos(phi)*sin(phi) + 8*3^(1/2)*L*l_tri^3*theta^3*sin(theta/2)^4*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))*cos(phi)*sin(phi) + 96*3^(1/2)*L^3*l_tri*theta*sin(theta/2)^4*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*cos(phi)*sin(phi)))/(192*theta^4*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^4) - (3^(1/2)*dtheta*l_tri*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*(cos(theta)/2 - 1/2)*(3*L*cos(mod(Rp1 + phi, (2*pi)/3)) - 3^(1/2)*l_tri*theta + 3*3^(1/2)*L*sin(mod(Rp1 + phi, (2*pi)/3))))/(72*theta*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2);

c21 =  (dtheta*((m0*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(cos(theta)/2 - 1/2)*(sin(2*phi)*(cos(theta)/2 - 1/2) - sin(theta/2)^6*sin(phi)^4*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + 3*sin(theta/2)^6*cos(phi)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/2 - (m0*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(cos(theta)/2 - 1/2)*(sin(2*phi)*(cos(theta)/2 - 1/2) - sin(theta/2)^6*cos(phi)^4*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + 3*sin(theta/2)^6*cos(phi)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/2 + 2*m0*cos(theta/2)^3*sin(theta/2)^5*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^4 - m0*cos(phi)*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(cos(theta)/2 - 1/2)*(cos(theta)/2 - cos(phi)^2*(cos(theta)/2 - 1/2) + sin(theta/2)^6*cos(phi)*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + 1/2) + m0*cos(phi)*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(cos(theta)/2 - 1/2)*(cos(theta)/2 - sin(phi)^2*(cos(theta)/2 - 1/2) + sin(theta/2)^6*cos(phi)^3*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + 1/2) + 2*m0*cos(theta/2)*sin(theta/2)^5*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^4*(cos(theta)/2 - 1/2)))/4 + (cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*((3*dphi*m0*sin(theta/2)*(cos(theta) - 1)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))))/2 - dtheta*m0*sin(theta/2)^3*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2)) + (5*dphi*m0*sin(theta)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(cos(theta)/2 - 1/2))/4 + (3^(1/2)*l_tri*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2)*((dtheta*m0*sin(theta/2)*(36*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*(cos(theta)/2 - 1/2) - 72*L^3*sin(theta/2)^6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*cos(phi)^3*sin(phi)^3 - 54*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*cos(phi)^2*(cos(theta)/2 + 1/2) + 18*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*cos(phi)^4*(cos(theta)/2 - 1/2) - 54*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*sin(phi)^2*(cos(theta)/2 + 1/2) + 18*L*theta^2*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3*sin(phi)^4*(cos(theta)/2 - 1/2) - 6*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*(cos(theta)/2 - 1/2) + 3^(1/2)*l_tri^3*theta^3*sin(theta/2)^6*cos(phi)^3*sin(phi)^3 + 9*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*cos(phi)^2*(cos(theta)/2 + 1/2) - 3*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*cos(phi)^4*(cos(theta)/2 - 1/2) + 9*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*sin(phi)^2*(cos(theta)/2 + 1/2) - 3*3^(1/2)*l_tri*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*sin(phi)^4*(cos(theta)/2 - 1/2) - 18*L*l_tri^2*theta^2*sin(theta/2)^6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))*cos(phi)^3*sin(phi)^3 + 36*3^(1/2)*L^2*l_tri*theta*sin(theta/2)^6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2*cos(phi)^3*sin(phi)^3))/(72*theta^3*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3) - dphi*m0*sin(theta/2)^3*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2)))/(6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2) + dphi*m0*sin(theta/2)*(cos(theta) - 1)*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (3^(1/2)*l_tri*m0*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*(3*sin(theta/2) - (3*cos(theta/2 + pi/6 - 2*mod(Rp1 + phi, (2*pi)/3)))/4 + sin(theta/2 + pi/3 + 2*mod(Rp1 + phi, (2*pi)/3))/4))/(12*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^3) - m0*sin(theta/2)^3*cos(phi)*((2^(1/2)*sin(2*phi + pi/4))/2 - 1/2)*(dtheta*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2) + (3^(1/2)*dphi*l_tri*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2))/(6*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2))*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta)/2 - 1/2)*(cos(theta)/2 + 1/2) + (3^(1/2)*dtheta*l_tri*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*(cos(theta)/2 - 1/2)*(3*L*cos(mod(Rp1 + phi, (2*pi)/3)) - 3^(1/2)*l_tri*theta + 3*3^(1/2)*L*sin(mod(Rp1 + phi, (2*pi)/3))))/(72*theta*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(pi/6 + mod(Rp1 + phi, (2*pi)/3))^2);

c22 =   ((dtheta*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2) + (3^(1/2)*dphi*l_tri*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2))/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))^2))*(2*m0*sin(theta/2)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*cos(theta/2)^2*sin(theta/2)*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*cos(theta/2)^2*sin(theta/2)*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))))/4 + ((cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*((dtheta*(2*m0*sin(theta/2)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + m0*sin(theta/2)*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))*(sin(theta/2)^2*sin(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)^3*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2) + 2*m0*cos(theta/2)^2*sin(theta/2)*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*cos(theta/2)^2*sin(theta/2)*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*sin(theta/2)^7*cos(phi)^3*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3 + m0*sin(theta/2)*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))*(sin(theta/2)^2*cos(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2)))/2 + 2*dphi*m0*cos(theta/2)^2*sin(theta/2)^3*cos(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta/2)^2 - 1)*(cos(phi)^2 + sin(phi)*cos(phi) - 1)))/2 - (cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*((dtheta*(2*m0*sin(theta/2)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + m0*sin(theta/2)*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))*(sin(theta/2)^2*sin(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)^3*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2) + 2*m0*cos(theta/2)^2*sin(theta/2)*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*cos(theta/2)^2*sin(theta/2)*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*sin(theta/2)^7*cos(phi)^3*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3 + m0*sin(theta/2)*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))*(sin(theta/2)^2*cos(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2)))/4 + dphi*m0*cos(theta/2)^2*sin(theta/2)^3*cos(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3*(cos(theta/2)^2 - 1)*(cos(phi)^2 + sin(phi)*cos(phi) - 1)) + (dtheta*(4*m0*cos(theta/2)*sin(theta/2)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + (m0*sin(theta/2)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(2*cos(theta/2)*sin(theta/2)*sin(phi)^2 - 2*cos(theta/2)*sin(theta/2) + 4*cos(theta/2)*sin(theta/2)^5*cos(phi)^3*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/2 - 4*m0*cos(theta/2)*sin(theta/2)^3*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 - 4*m0*cos(theta/2)*sin(theta/2)^3*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + (m0*sin(theta/2)^2*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(2*cos(theta/2)*sin(theta/2)*cos(phi)^2 - 2*cos(theta/2)*sin(theta/2) + 4*cos(theta/2)*sin(theta/2)^5*cos(phi)*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/2))/8 + (dphi*((m0*sin(theta/2)^2*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(sin(theta/2)^6*sin(phi)^4*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + 2*sin(theta/2)^2*cos(phi)*sin(phi) - 3*sin(theta/2)^6*cos(phi)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/2 - (m0*sin(theta/2)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(sin(theta/2)^6*cos(phi)^4*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2 + 2*sin(theta/2)^2*cos(phi)*sin(phi) - 3*sin(theta/2)^6*cos(phi)^2*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2))/2 + m0*sin(theta/2)^2*cos(phi)*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(sin(theta/2)^2*cos(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2) - m0*sin(theta/2)^2*cos(phi)*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2*(sin(theta/2)^2*sin(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)^3*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2)))/4 + ((dtheta*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2) + (3^(1/2)*dphi*l_tri*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*sin(theta/2))/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))^2))*(2*m0*sin(theta/2)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + m0*sin(theta/2)*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))*(sin(theta/2)^2*sin(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)^3*sin(phi)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2) + 2*m0*cos(theta/2)^2*sin(theta/2)*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*cos(theta/2)^2*sin(theta/2)*sin(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) + 2*m0*sin(theta/2)^7*cos(phi)^3*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^3 + m0*sin(theta/2)*cos(phi)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))*(sin(theta/2)^2*cos(phi)^2 + cos(theta/2)^2 + sin(theta/2)^6*cos(phi)*sin(phi)^3*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))))^2)))/4 + m0*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2)*(sin(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (2*L*cos(theta/2))/theta^2 + (2*L*sin(theta/2))/theta^3);

C_simp=[c11 c12;c21 c22];
g11=(3^(1/2)*g*l_tri*m0*sin(pi/3 - mod(Rp1 + phi, (2*pi)/3))*cos(theta/2)*sin(theta/2))/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3))^2);

g21=g*m0*cos(theta/2)*(cos(theta/2)*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))) - (L*sin(theta/2))/theta^2) - (g*m0*sin(theta/2)^2*(L/theta - (3^(1/2)*l_tri)/(6*cos(pi/3 - mod(Rp1 + phi, (2*pi)/3)))))/2;


G_simp=[g11;g21];
K=[k11 0;0 k22];
B=[b11 0; 0 b22];
A = [a11 0;0 a22];
tempVec=[];
tau_xy=[sqrt(3)*0.5*(pm3-pm1);
    pm2-0.5*(pm1 + pm3)];
tau_a=A*[-cos(phi)*sin(theta) -sin(phi);
    -sin(phi)*sin(theta) cos(phi)]*tau_xy;
tempVec = M\(tau_a-(B+C_simp)*[x(2);x(4)] - G_simp - K*[x(1); x(3)]);
dx = [x(2);
    tempVec(1);
    x(4)
    tempVec(2)];
end